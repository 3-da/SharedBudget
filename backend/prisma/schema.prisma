generator client {
  provider     = "prisma-client"
  output       = "../src/generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

//#region Enums ####################################################################################################

enum HouseholdRole {
  OWNER
  MEMBER
}

enum ExpenseType {
  PERSONAL
  SHARED
}

enum ExpenseCategory {
  RECURRING
  ONE_TIME
}

enum ExpenseFrequency {
  MONTHLY
  YEARLY
}

enum YearlyPaymentStrategy {
  FULL
  INSTALLMENTS
}

enum InstallmentFrequency {
  MONTHLY // 12 payments per year
  QUARTERLY // 4 payments: Jan, Apr, Jul, Oct
  SEMI_ANNUAL // 2 payments: Jan & Jul
}

enum ApprovalAction {
  CREATE
  UPDATE
  DELETE
  WITHDRAW_SAVINGS
}

enum ApprovalStatus {
  PENDING
  ACCEPTED
  REJECTED
  CANCELLED
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  DECLINED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  CANCELLED
}

//#endregion ####################################################################################################

//#region Models ####################################################################################################

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  firstName     String
  lastName      String
  emailVerified Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime?

  householdMember     HouseholdMember?
  salaries            Salary[]
  createdExpenses     Expense[]              @relation("ExpenseCreator")
  paidExpenses        Expense[]              @relation("ExpensePayer")
  requestedApprovals  ExpenseApproval[]      @relation("ApprovalRequester")
  reviewedApprovals   ExpenseApproval[]      @relation("ApprovalReviewer")
  sentInvitations     HouseholdInvitation[]  @relation("InvitationSender")
  receivedInvitations HouseholdInvitation[]  @relation("InvitationTarget")
  settlementsPaid     Settlement[]           @relation("SettlementPayer")
  settlementsReceived Settlement[]           @relation("SettlementReceiver")
  paymentStatuses     ExpensePaymentStatus[] @relation("PaymentStatusPayer")
  savings             Saving[]

  @@map("users")
}

model Household {
  id         String   @id @default(uuid())
  name       String
  inviteCode String   @unique
  maxMembers Int      @default(2)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  members     HouseholdMember[]
  salaries    Salary[]
  expenses    Expense[]
  approvals   ExpenseApproval[]
  invitations HouseholdInvitation[]
  settlements Settlement[]
  savings     Saving[]

  @@map("households")
}

model HouseholdMember {
  id          String        @id @default(uuid())
  userId      String        @unique
  householdId String
  role        HouseholdRole @default(MEMBER)
  joinedAt    DateTime      @default(now())

  user      User      @relation(fields: [userId], references: [id], onDelete: Restrict)
  household Household @relation(fields: [householdId], references: [id], onDelete: Cascade)

  @@unique([userId, householdId])
  @@index([householdId])
  @@map("household_members")
}

model HouseholdInvitation {
  id           String           @id @default(uuid())
  status       InvitationStatus @default(PENDING)
  householdId  String
  senderId     String
  targetUserId String
  createdAt    DateTime         @default(now())
  respondedAt  DateTime?

  household  Household @relation(fields: [householdId], references: [id], onDelete: Cascade)
  sender     User      @relation("InvitationSender", fields: [senderId], references: [id])
  targetUser User      @relation("InvitationTarget", fields: [targetUserId], references: [id])

  @@index([targetUserId, status])
  @@index([householdId, status])
  @@index([senderId])
  @@map("household_invitations")
}

model Salary {
  id            String   @id @default(uuid())
  userId        String
  householdId   String
  defaultAmount Decimal  @db.Decimal(12, 2)
  currentAmount Decimal  @db.Decimal(12, 2)
  month         Int
  year          Int
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user      User      @relation(fields: [userId], references: [id], onDelete: Restrict)
  household Household @relation(fields: [householdId], references: [id], onDelete: Cascade)

  @@unique([userId, month, year])
  @@index([householdId])
  @@map("salaries")
}

model Expense {
  id                    String                 @id @default(uuid())
  householdId           String
  createdById           String
  name                  String                 @db.VarChar(100)
  amount                Decimal                @db.Decimal(12, 2)
  type                  ExpenseType
  category              ExpenseCategory
  frequency             ExpenseFrequency
  yearlyPaymentStrategy YearlyPaymentStrategy?
  installmentFrequency  InstallmentFrequency?
  installmentCount      Int?
  paymentMonth          Int?
  paidByUserId          String?
  month                 Int?
  year                  Int?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  deletedAt             DateTime?

  household          Household              @relation(fields: [householdId], references: [id], onDelete: Cascade)
  createdBy          User                   @relation("ExpenseCreator", fields: [createdById], references: [id], onDelete: Restrict)
  paidBy             User?                  @relation("ExpensePayer", fields: [paidByUserId], references: [id], onDelete: Restrict)
  approvals          ExpenseApproval[]
  paymentStatuses    ExpensePaymentStatus[]
  recurringOverrides RecurringOverride[]

  @@index([householdId, type])
  @@index([createdById])
  @@map("expenses")
}

model ExpenseApproval {
  id            String         @id @default(uuid())
  expenseId     String?
  householdId   String
  action        ApprovalAction
  status        ApprovalStatus @default(PENDING)
  requestedById String
  reviewedById  String?
  message       String?
  proposedData  Json?
  createdAt     DateTime       @default(now())
  reviewedAt    DateTime?

  expense     Expense?  @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  household   Household @relation(fields: [householdId], references: [id], onDelete: Cascade)
  requestedBy User      @relation("ApprovalRequester", fields: [requestedById], references: [id], onDelete: Restrict)
  reviewedBy  User?     @relation("ApprovalReviewer", fields: [reviewedById], references: [id], onDelete: Restrict)

  @@index([householdId, status])
  @@index([requestedById])
  @@map("expense_approvals")
}

model Settlement {
  id           String   @id @default(uuid())
  householdId  String
  month        Int
  year         Int
  amount       Decimal  @db.Decimal(12, 2)
  paidByUserId String
  paidToUserId String
  paidAt       DateTime @default(now())

  household Household @relation(fields: [householdId], references: [id], onDelete: Cascade)
  paidBy    User      @relation("SettlementPayer", fields: [paidByUserId], references: [id], onDelete: Restrict)
  paidTo    User      @relation("SettlementReceiver", fields: [paidToUserId], references: [id], onDelete: Restrict)

  @@unique([householdId, month, year])
  @@map("settlements")
}

model ExpensePaymentStatus {
  id        String        @id @default(uuid())
  expenseId String
  month     Int
  year      Int
  status    PaymentStatus @default(PENDING)
  paidAt    DateTime?
  paidById  String
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  expense Expense @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  paidBy  User    @relation("PaymentStatusPayer", fields: [paidById], references: [id], onDelete: Restrict)

  @@unique([expenseId, month, year])
  @@index([expenseId])
  @@map("expense_payment_statuses")
}

model RecurringOverride {
  id        String   @id @default(uuid())
  expenseId String
  month     Int
  year      Int
  amount    Decimal  @db.Decimal(12, 2)
  skipped   Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  expense Expense @relation(fields: [expenseId], references: [id], onDelete: Cascade)

  @@unique([expenseId, month, year])
  @@index([expenseId])
  @@map("recurring_overrides")
}

model Saving {
  id          String   @id @default(uuid())
  userId      String
  householdId String
  amount      Decimal  @db.Decimal(12, 2)
  month       Int
  year        Int
  isShared    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user      User      @relation(fields: [userId], references: [id], onDelete: Restrict)
  household Household @relation(fields: [householdId], references: [id], onDelete: Cascade)

  @@unique([userId, month, year, isShared])
  @@index([householdId])
  @@map("savings")
}

//#endregion ####################################################################################################
